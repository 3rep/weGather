<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gather.we.dao.MypageDAO">
	<select id="getUserinfo" resultType="com.gather.we.dto.MypageUserDTO">
		select userid, type, username, password, email, tel, address, gender, mbti, rank, signupdate from users where userid=#{param1}
	</select> 
	<select id="getUsername" resultType="String">
		select username from users where userid=#{param1}
	</select>
	
	<select id="allgameList" resultType="com.gather.we.dto.MypageApplyListDTO">
		select participate.userid, game.no, game.s_no, game.st_no, game.gametime, game.g_status, s.sportname, si.stadium, gt2ago
		from (select no, s_no, st_no, gametime, g_status, gametime-2 gt2ago from rank_game rg
		      union
		      select no, s_no, st_no, gametime, g_status, gametime-2 gt2ago from norm_game ng) game
		join 
		    (select no, userid from r_participate rp
		    union
		    select no, userid from n_participate np) participate
		on game.no = participate.no and participate.userid = #{param1}
		join sport s
		on s.s_no = game.s_no
		join stadium_info si
		on si.st_no = game.st_no
		order by game.gametime desc
	</select>
	
	<select id="rankgameList" resultType="com.gather.we.dto.MypageApplyListDTO">
		select rp.userid, rg.no, s.sportname, rg.gametime, si.stadium, rg.g_status, rg.gametime-2 gt2ago from r_participate rp
		join rank_game rg
		on rp.no = rg.no and rp.userid=#{param1}
		join stadium_info si
		on rg.st_no = si.st_no
		join sport s
		on rg.s_no = s.s_no
		order by rg.gametime desc
	</select>
	<select id="normgameList" resultType="com.gather.we.dto.MypageApplyListDTO">
		select np.userid, ng.no, s.sportname, ng.gametime, si.stadium, ng.g_status, ng.gametime-2 gt2ago from norm_game ng
		join n_participate np
		on np.no = ng.no and np.userid=#{param1}
		join stadium_info si
		on si.st_no = ng.st_no
		join sport s
		on s.s_no = ng.s_no
		order by ng.gametime desc
	</select>
	<select id="rank" resultType="com.gather.we.dto.MypageRankDTO">
		select rp.userid, rg.no, rg.gametime, rp.rank, rg.g_status, s.sportname, 
		floor(avg(rp.rank) over(partition by s.sportname)) avg_sn, 
		floor(avg(rp.rank) over(partition by rp.userid)) avg_all,
		row_number() over(partition by s.sportname order by rg.gametime desc) rn
		from (select * from rank_game where g_status=1 order by gametime desc) rg 
		join (select * from r_participate where rank>=1) rp
		on rp.no=rg.no and userid=#{param1}
		join sport s 
		on s.s_no = rg.s_no and sportname=#{param2}
	</select>
	
	
	
</mapper>